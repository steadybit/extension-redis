/*
 * Copyright 2024 steadybit GmbH. All rights reserved.
 */

package extredis

import (
	"fmt"

	"github.com/steadybit/discovery-kit/go/discovery_kit_api"
	"github.com/steadybit/extension-redis/config"
)

const (
	// Target types
	TargetTypeInstance = "com.steadybit.extension_redis.instance"
	TargetTypeDatabase = "com.steadybit.extension_redis.database"

	// Common attribute names
	AttrRedisURL         = "redis.url"
	AttrRedisHost        = "redis.host"
	AttrRedisPort        = "redis.port"
	AttrRedisVersion     = "redis.version"
	AttrRedisRole        = "redis.role"
	AttrRedisClusterMode = "redis.cluster.enabled"
	AttrRedisMemoryUsed  = "redis.memory.used_bytes"
	AttrRedisMemoryMax   = "redis.memory.max_bytes"
	AttrRedisClients     = "redis.connected_clients"
	AttrRedisUptime      = "redis.uptime_seconds"
	AttrRedisName        = "redis.name"

	AttrDatabaseIndex = "redis.database.index"
	AttrDatabaseKeys  = "redis.database.keys"
	AttrDatabaseName  = "redis.database.name"
)

var redisIcon = "data:iamge/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTIxLjk5NDQgMTMuNTIxM0MyMS45ODgxIDEzLjcxMzEgMjEuNzMzOCAxMy45MjUgMjEuMjE2MyAxNC4xOTVDMjAuMTQ4OCAxNC43NTE5IDE0LjYyMTIgMTcuMDI2OSAxMy40NDI1IDE3LjYzODhDMTIuMjY0NCAxOC4yNTM4IDExLjYxMzEgMTguMjQ3NSAxMC42ODE5IDE3LjgwMTNDOS43NTA2MyAxNy4zNTg4IDMuODY4NzUgMTQuOTc4OCAyLjgwNzUgMTQuNDc0NEMyLjI4IDE0LjIyMDYgMi4wMSAxNC4wMDg4IDIgMTMuODA2OVYxNS44MjgxQzIgMTYuMDMgMi4yOCAxNi4yNDEzIDIuODA3NSAxNi40OTU2QzMuODY4NzUgMTcuMDAzOCA5Ljc1NDM4IDE5LjM4IDEwLjY4MTkgMTkuODIyNUMxMS42MTMxIDIwLjI2ODggMTIuMjYzNyAyMC4yNzUgMTMuNDQyNSAxOS42NkMxNC42MjA2IDE5LjA0ODEgMjAuMTQ4MSAxNi43NzI1IDIxLjIxNjMgMTYuMjE2M0MyMS43NiAxNS45MzYzIDIyLjAwMDYgMTUuNzE1IDIyLjAwMDYgMTUuNTE2M0MyMi4wMDA2IDE1LjMyNzUgMjIuMDAwNiAxMy41MjM4IDIyLjAwMDYgMTMuNTIzOEMyMi4wMDA2IDEzLjUyMDYgMjEuOTk3NSAxMy41MjA2IDIxLjk5NDQgMTMuNTIwNlYxMy41MjEzWk0yMS45OTQ0IDEwLjIyNjlDMjEuOTg0NCAxMC40MTU2IDIxLjczMzggMTAuNjI3NSAyMS4yMTYzIDEwLjkwMDZDMjAuMTQ4OCAxMS40NTM4IDE0LjYyMTIgMTMuNzI5NCAxMy40NDI1IDE0LjM0MTNDMTIuMjY0NCAxNC45NTYzIDExLjYxMzEgMTQuOTUgMTAuNjgxOSAxNC41MDc1QzkuNzUwNjMgMTQuMDYxMyAzLjg2ODc1IDExLjY4NSAyLjgwNzUgMTEuMTc3NUMyLjI4IDEwLjkyNjkgMi4wMSAxMC43MTE5IDIgMTAuNTFWMTIuNTMxM0MyIDEyLjczMzEgMi4yOCAxMi45NDgxIDIuODA3NSAxMy4xOTg4QzMuODY4NzUgMTMuNzA2OSA5Ljc1MDYzIDE2LjA4MzEgMTAuNjgxOSAxNi41Mjg4QzExLjYxMzEgMTYuOTcxMyAxMi4yNjM3IDE2Ljk3ODEgMTMuNDQyNSAxNi4zNjYzQzE0LjYyMDYgMTUuNzUxMyAyMC4xNDgxIDEzLjQ3ODggMjEuMjE2MyAxMi45MjI1QzIxLjc2IDEyLjYzOTQgMjIuMDAwNiAxMi40MTgxIDIyLjAwMDYgMTIuMjE5NEMyMi4wMDA2IDEyLjAzMDYgMjIuMDAwNiAxMC4yMjY5IDIyLjAwMDYgMTAuMjI2OUMyMi4wMDA2IDEwLjIyNjkgMjEuOTk3NSAxMC4yMjY5IDIxLjk5NDQgMTAuMjI2OVpNMjEuOTk0NCA2LjgwNTYzQzIyLjAwNDQgNi42MDM3NiAyMS43NDA2IDYuNDI1MDEgMjEuMjAzMSA2LjIyOTM4QzIwLjE2NSA1Ljg0ODc2IDE0LjY2NjkgMy42NjEyNiAxMy42MTUgMy4yNzM3NkMxMi41NjM3IDIuODg5MzggMTIuMTMzOCAyLjkwNTYzIDEwLjg5NjkgMy4zNDg3NkM5LjY2IDMuNzk1MDEgMy44MSA2LjA4OTM4IDIuNzY4NzUgNi40OTYyNkMyLjI0ODEzIDYuNzAxMjYgMS45OTM3NSA2Ljg5MDAxIDIuMDAzNzUgNy4wOTE4OFY5LjExMzEzQzIuMDAzNzUgOS4zMTUwMSAyLjI4MDYzIDkuNTI2MjYgMi44MTEyNSA5Ljc4MDYzQzMuODY5MzggMTAuMjg4OCA5Ljc1NDM4IDEyLjY2NSAxMC42ODU2IDEzLjExMDZDMTEuNjEzMSAxMy41NTMxIDEyLjI2NzUgMTMuNTYgMTMuNDQ2MiAxMi45NDQ0QzE0LjYyMTIgMTIuMzMyNSAyMC4xNTE5IDEwLjA1NjkgMjEuMjIgOS41MDM3NkMyMS43NjA2IDkuMjIwNjMgMjIuMDAxMiA4Ljk5OTM4IDIyLjAwMTIgOC44MDA2M0MyMi4wMDEyIDguNjExODggMjIuMDAxMiA2LjgwNTAxIDIyLjAwMTIgNi44MDUwMUwyMS45OTQ0IDYuODA1NjNaTTkuMTYxODggOC43MjAwMUwxMy43OTc1IDguMDEwNjNMMTIuMzk3NSAxMC4wNjEzTDkuMTYxODggOC43MjAwMVpNMTkuNDEyNSA2Ljg3MDYzTDE2LjM3NTYgOC4wNzE4OEwxMy42MzUgNi45ODgxM0wxNi42Njg3IDUuNzkwMDFMMTkuNDEyNSA2Ljg3MDYzWk0xMS4zNjU2IDQuODg1MDFMMTAuOTE2MyA0LjA1ODEzTDEyLjMxNjIgNC42MDUwMUwxMy42MzQ0IDQuMTc1MDFMMTMuMjc2MiA1LjAyODEzTDE0LjYyMDYgNS41MzI1MUwxMi44ODg3IDUuNzExMjZMMTIuNDk4MSA2LjY0NTYzTDExLjg3MzEgNS42MDM3Nkw5Ljg3MTI1IDUuNDI1MDFMMTEuMzY1NiA0Ljg4NTAxWk03LjkxMTg4IDYuMDUzNzZDOS4yODI1IDYuMDUzNzYgMTAuMzg5NCA2LjQ4Mzc2IDEwLjM4OTQgNy4wMTA2M0MxMC4zODk0IDcuNTQxMjYgOS4yNzkzOCA3Ljk3MDYzIDcuOTExODggNy45NzA2M0M2LjU0NDM4IDcuOTcwNjMgNS40MzQzNyA3LjU0MDYzIDUuNDM0MzcgNy4wMTA2M0M1LjQzNDM3IDYuNDgzMTMgNi41NDQzOCA2LjA1Mzc2IDcuOTExODggNi4wNTM3NloiIGZpbGw9ImN1cnJlbnRDb2xvciIvPjwvc3ZnPg=="

// FetchTargetsPerEndpoint iterates through all configured endpoints and collects targets
func FetchTargetsPerEndpoint(handler func(endpoint *config.RedisEndpoint) ([]discovery_kit_api.Target, error)) ([]discovery_kit_api.Target, error) {
	var allTargets []discovery_kit_api.Target

	for _, endpoint := range config.Config.Endpoints {
		targets, err := handler(&endpoint)
		if err != nil {
			// Log error but continue with other endpoints
			fmt.Printf("Error discovering targets for endpoint %s: %v\n", endpoint.URL, err)
			continue
		}
		allTargets = append(allTargets, targets...)
	}

	return allTargets, nil
}
